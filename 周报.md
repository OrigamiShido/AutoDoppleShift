# 周报

首先找到5月17日的TLE数据，使用其进行轨道计算，并计算目标地点的多普勒频移率，和数据绘图作比较，得出结果。

由于[celetrak.org](https://celestrak.org/NORAD/elements/)只记录当天的TLE数据，因此使用[space-track.org](https://www.space-track.org/)获取历史TLE数据。

## 历史星历数据收集

首先找17号的tle数据。由于celestrak只提供当天的tle数据，因此采用[space-track的API调用](https://www.space-track.org/basicspacedata/query/class/tle/EPOCH/2025-05-17%2003:00:00--2025-05-17%2005:00:00/OBJECT_NAME/%5EStarlink/orderby/norad_cat_id/format/3le)获得了5月17日11:00-13:00的TLE数据。

## 多普勒频移预报

对于多普勒频移的预报，我们同样采用`SatelliteScenario`对象，使用`dopplershift`函数能够直接获得卫星的预报多普勒频移率：

```matlab
%% 定义数值
% tic
disp('begin...')
latitude=30.5288888;
longitude=114.3530555;
altitude=56;
minelevation=60;
durationtimeSeconds=300;
starttime=datetime(2025,5,31,14,0,0,'TimeZone',hours(8));
sampletime=1;

%% 模拟环境
disp('creating satellitescenario object...')
% 创建图窗
sc = satelliteScenario(starttime,starttime+seconds(durationtimeSeconds),sampletime);

%% 地面站
disp('creating groundstation...')
% 创建地面站
gs=groundStation(sc,Name='WHU',Latitude=latitude,Longitude=longitude,Altitude=altitude,MinElevationAngle=minelevation);

%% 导入卫星
disp('importing satellites...')
% 创建和读取卫星，渲染轨道
sat=satellite(sc,[pwd,'\gp.tle'],OrbitPropagator="sgp4");
%% 预报多普勒频移
disp('Predicting Doppler shift...')
carrierFrequency=11.325e9;
[frequencyShift,timeOut,dopplerInfo] = dopplershift(sat,gs,Frequency=carrierFrequency);
frequencyRate = dopplerInfo.DopplerRate;
relativeVelocity = dopplerInfo.RelativeVelocity;

%% 做表，删除nan行
rowname=string(starttime:seconds(sampletime):starttime+seconds(durationtimeSeconds-1));
frequencyRate=array2table(frequencyRate','RowNames',rowname,'VariableNames',sat.Name);
frequencyRate(:,all(isnan(frequencyRate{:,:})))=[];
```

在函数`dopplershift`中，返回值`dopplerInfo.DopplerRate`包含了函数在预测时间内的多普勒变化率（Hz/s）。由于需要精确的测量，可以将卫星预报时间限定于接收时间的数分钟内。在上述代码的试运行中，将时间限定为以1s为步进的五分钟内。运行得到以下表：

![image-20250609150412110](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20250609150412110.png)

即为五分钟内每秒预测的多普勒频移时刻。

## 接收机数据多普勒频移侦测

对于接收机的多普勒频移侦测，存在两种方法，一是通过看图进行手动计算，二是通过程序代码进行计算。

对于图像较为明显的图片来说，能够通过程序代码进行侦测计算。在这里通过霍夫变换侦测图像中的多普勒频移直线并拟合斜率：

```matlab
% 1. STFT幅值谱
S_abs = abs(s);
% S_norm = mat2gray(S_abs); % 归一化

% 2. 对数增强与二值化
S_log = 20*log(S_abs);
bw = imbinarize(S_log, 'adaptive', 'ForegroundPolarity', 'bright', 'Sensitivity', 0.6);

% 3. 去噪和形态学闭运算
bw = bwareaopen(bw, 10);
bw = imclose(bw, strel('line', 7, 0)); % 横向闭运算，可调长度

% 4. 霍夫变换检测直线
[H, theta, rho] = hough(bw);
peaks = houghpeaks(H, 6, 'threshold', ceil(0.2 * max(H(:)))); % 最多6条直线
lines = houghlines(bw, theta, rho, peaks, 'FillGap', 12, 'MinLength', 20);

% 5. 可视化原频谱和所有直线
figure;
imagesc(f, t, S_abs);
axis xy;
xlabel('Frequency (Hz)');
ylabel('Time (s)');
title('Detected Doppler Lines');
colormap jet;
colorbar;
hold on;

rates=zeros(1,length(lines));
for k = 1:length(lines)
    % 图像坐标到物理坐标
    x1 = interp1(1:length(f), f, lines(k).point1(1));
    y1 = interp1(1:length(t), t, lines(k).point1(2));
    x2 = interp1(1:length(f), f, lines(k).point2(1));
    y2 = interp1(1:length(t), t, lines(k).point2(2));
    plot([x1 x2], [y1 y2], '-', 'LineWidth', 2, 'Color', rand(1,3));
    
    % 计算多普勒频移率
    doppler_rate = (x2 - x1) / (y2 - y1); % Hz/s
    fprintf('Line %d: Doppler rate = %.3f Hz/s\n', k, doppler_rate);
    rates(k)=doppler_rate;
end
hold off;
legend('Detected Doppler Lines');
result=mean(rates);
```

最后得到：

![result](C:\Users\Admin\Desktop\WHU study\Starlink\AutoDoppleShift\result.svg)

![image-20250609150831960](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20250609150831960.png)

能够看出，通过简单的霍夫变换能够良好的发现明显图像中的多普勒频移图像并计算斜率。函数返回多条线的多普勒频移的均值。

然而，对于较为不明显的图像来说，这种方法不能够侦测到图像，需要进行进一步微调。



## 卫星名称预测

在获得实际数据中得到的多普勒频移和多普勒频移预报表后，通过查找在特征时间内最接近的卫星名称来实现卫星名称预测：

```matlab
%% 数值定义
targetTime=[datetime(2025,5,17,15,39,57,698,'TimeZone',hours(8)) datetime(2025,5,17,15,44,29,94,'TimeZone',hours(8))];
k=2;
%% 预报表和多普勒频移
frequencyRate=dopplercalc();
%% 预报图
analysisData=process_all_files([pwd,'\data'],'result','stft');

%% 检测和找到多普勒频移量
doppler_rates=hough_detection(analysisData(k).frequency,analysisData(k).time,analysisData(k).Signal);

%% 找到最接近的卫星名称
[~,idx]=min(abs(doppler_rates-frequencyRate(string(targetTime(k):seconds(1):targetTime(k)+seconds(5)),:)),[],2);
satelliteResult=frequencyRate(:,unique(idx{:,:},'stable')).Properties.VariableNames;
disp('预测卫星：');
disp(satelliteResult);
```

![image-20250609171744712](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20250609171744712.png)

使用了简单的寻找最小值方法。最后能够得到预测卫星。

## 改进

### 多普勒频移侦测的改进

在上文中使用的多普勒频移侦测方法，只能够对于明显谱线图进行区分，对于信噪比低，不明显的图片则不能区分，因此需要进行改进。



### 使用仰角和方向角进行辅助判断

可以通过仰角和方向角对于卫星先进行初筛。

在数据采集过程中，锅天线设置的大致仰角是30-90度，方位角限制是45度-135度。



### 使用高精度星历进行判断



## 最终结果

